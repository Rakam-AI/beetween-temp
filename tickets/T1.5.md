# T1.5 - Update Keycloak Configuration for DAR Realm


**Depends on:** T1.1
**Blocks:** T1.6, T2.17

**Context:**
The current template uses a `Beetween` realm with a simple `GREG` role. The DAR service requires a dedicated `dar` realm with specific clients (`dar-ui`, `dar-api`), roles (ADMIN, MANAGER, RECRUITER, HR_MANAGER), groups, and development users.

Reference: `UI_Technical Specification V1 (FR) - AUTHENTICATION.md`

**Objective:**
Create a new Keycloak realm configuration for the DAR service and update all related configurations.

**Instructions:**
1. **Create `docker/dar-realm.json`** (new Keycloak realm export) containing:
   - Realm name: `dar`
   - Client `dar-ui` (Public):
     - Type: public
     - Protocol: openid-connect
     - Direct Access: enabled
     - Standard Flow: enabled
     - Redirect URIs: `http://localhost:3000/*`, `http://localhost:3001/*`
     - Web Origins: `http://localhost:3000`, `http://localhost:3001`
     - Default scopes: web-origins, roles, profile, email
   - Client `dar-api` (Bearer-only):
     - Type: bearer-only
     - Protocol: openid-connect
   - Realm Roles: `ADMIN`, `MANAGER`, `RECRUITER`, `HR_MANAGER`
   - Groups: `ADMIN`, `MANAGER`, `RECRUITER`, `HR_MANAGER` (each group mapped to its role)
   - Development users (all with simple passwords = username):
     - `ADMIN_U1` (email: admin@dar.com, group: ADMIN)
     - `ADMIN_U2` (email: admin2@dar.com, group: ADMIN)
     - `MANAGER_U1` (email: manager@dar.com, group: MANAGER)
     - `MANAGER_U2` (email: manager2@dar.com, group: MANAGER)
     - `RECRUITER_U1` (email: recruiter@dar.com, group: RECRUITER)
     - `RECRUITER_U2` (email: recruiter2@dar.com, group: RECRUITER)
     - `HR_MANAGER_U1` (email: hr@dar.com, group: HR_MANAGER)
     - `HR_MANAGER_U2` (email: hr2@dar.com, group: HR_MANAGER)
   - Each user must have a fixed UUID to allow deterministic testing
   - Add a `companyId` custom attribute to each user (all dev users share the same companyId UUID)
   - Configure the realm to include `companyId`, `realm_access.roles` in the JWT token claims via protocol mappers

2. **Delete `docker/beetween-realm.json`** (old realm)

3. **Update `docker-compose.yml`** Keycloak service:
   - Import `./docker/dar-realm.json` instead of the old realm
   - Keep Keycloak on port 9999

4. **Update `application.yml`:**
   - Change `keycloak.realm` to `dar`
   - Change `keycloak.resource` / `client-id` to `dar-api`
   - Update JWT issuer URI to `http://localhost:9999/realms/dar`
   - Update role references from `GREG` to the new roles

5. **Update `SecurityWebConfig.kt`:**
   - Configure JWT decoder to extract roles from `realm_access.roles` claim
   - Configure JWT decoder to extract `companyId` from token claims
   - Remove any `GREG` role references

6. **Update test realm file** `src/test/resources/Beetween-realm.json`:
   - Replace with the same `dar-realm.json` content (or reference the same file)
   - Update `IntegrationTestBase` to use the new realm name

**Acceptance Criteria:**
- `docker compose up keycloak` starts Keycloak with the `dar` realm
- All 8 dev users can authenticate and receive JWT tokens with correct roles
- JWT tokens contain `companyId` claim
- Application validates tokens from the `dar` realm
- Tests work with the new realm
