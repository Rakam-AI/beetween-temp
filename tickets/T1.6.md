# T1.6 - Set Up JWT Token Generation Endpoint for Dev/Test


**Depends on:** T1.5
**Blocks:** T2.12, T2.13

**Context:**
The API specification requires `/token` endpoints (GET and POST) that generate JWT tokens for testing and development, without requiring Keycloak to be running. This simplifies API testing.

Reference: `API_Technical Specification V1.md` > Endpoints supplÃ©mentaires > `/token`

**Objective:**
Create token generation endpoints that produce valid JWT tokens matching the DAR security schema.

**Instructions:**
1. **Create `adapter/input/web/dev/TokenController.kt`:**
   - Annotated with `@RestController` and `@Profile("dev", "test")` (only available in dev/test)
   - `GET /api/v1/token`: Returns a map of pre-generated tokens for all roles:
     ```json
     {
       "ADMIN": "eyJ...",
       "RECRUITER": "eyJ...",
       "HR_MANAGER": "eyJ...",
       "MANAGER": "eyJ..."
     }
     ```
     - Each token corresponds to the `*_U1` dev users with a shared `companyId`
     - Tokens expire in 24 hours
   - `POST /api/v1/token`: Accepts a body to generate a custom token:
     ```json
     {
       "userId": "optional-uuid",
       "email": "optional-email",
       "role": "ADMIN|RECRUITER|HR_MANAGER|MANAGER",
       "companyId": "optional-uuid"
     }
     ```
     - Generate UUID for userId and companyId if not provided
     - Return the generated token

2. **Create a `JwtTokenGenerator` utility class:**
   - Uses a configurable signing key (from `application.yml` or env var `JWT_SECRET`)
   - Generates tokens with claims: `sub` (userId), `email`, `realm_access.roles`, `companyId`, `preferred_username`
   - Token expiration: 24 hours

3. **In `application.yml` (under dev profile):**
   ```yaml
   jwt:
     secret: dev-secret-key-minimum-256-bits-long-for-hs256
     expiration: 86400
   ```

4. **In `SecurityWebConfig.kt`:**
   - For dev/test profiles, configure the JWT decoder to accept both Keycloak-issued and locally-signed tokens
   - This allows using either Keycloak or the `/token` endpoint

5. **Exclude these endpoints from authentication** (they must be publicly accessible in dev)

**Acceptance Criteria:**
- `GET /api/v1/token` returns tokens for all 4 roles without authentication
- `POST /api/v1/token` generates a custom token
- Generated tokens are accepted by the API when used as Bearer tokens
- Endpoints are NOT available in production profile
- Tokens contain all required claims (sub, email, roles, companyId)
