# T2.15 - Implement MongoDB Request Repository


**Depends on:** T1.3, T2.6
**Blocks:** T2.20

**Context:**
The Request repository persists requests to MongoDB with support for complex queries, filtering, sorting, and optimistic locking.

**Objective:**
Create the MongoDB adapter implementing the RequestRepository port.

**Instructions:**

1. **Create `adapter/output/persistence/request/entity/RequestDocument.kt`:**
   - MongoDB document class annotated with `@Document("requests")`
   - All fields including nested businessInfo, additionalFieldValues, history
   - `@Version` for optimistic locking
   - `@CreatedDate`, `@LastModifiedDate`

2. **Create `adapter/output/persistence/request/RequestDocumentMapper.kt`:**
   - Bidirectional mapping between Request domain and RequestDocument
   - Handle nested objects (BusinessInfo, HistoryEntry, etc.)

3. **Create Spring Data repository interface**

4. **Create `adapter/output/persistence/request/MongoRequestRepositoryAdapter.kt`:**
   - Implements `RequestRepository` port
   - Implements filtering by status, workflowId, createdBy
   - Implements sorting by createdAt, updatedAt
   - Implements pagination
   - Handles `OptimisticLockingFailureException` â†’ maps to `ConcurrentModification` error

5. **Create MongoDB indexes:**
   - Compound index on (companyId, status)
   - Index on (companyId, workflowId)
   - Index on (companyId, creatorId)
   - Index on (status, currentStepIndex) for pending validation queries

**Acceptance Criteria:**
- All RequestRepository port methods implemented
- Nested business data persisted and restored correctly
- Filtering, sorting, pagination work
- Optimistic locking prevents concurrent modifications
- Proper indexes for query performance
