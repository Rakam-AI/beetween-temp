# T1.4 - Add Apache Pulsar Dependency & Configuration


**Depends on:** T1.1
**Blocks:** T2.16

**Context:**
The specification requires Apache Pulsar for asynchronous event emission. Events about request state changes and workflow changes must be published to Pulsar topics.

Reference: `API_Technical Specification V1.md` > "Gestion des événements - Apache Pulsar"

**Objective:**
Add Apache Pulsar client with configuration for local development. Include a simulation/logging mode for when Pulsar is not available.

**Instructions:**
1. **In `pom.xml`, add Pulsar client dependency:**
   ```xml
   <dependency>
       <groupId>org.apache.pulsar</groupId>
       <artifactId>pulsar-client</artifactId>
       <version>3.3.0</version>
   </dependency>
   ```

2. **In `application.yml`, add Pulsar configuration:**
   ```yaml
   pulsar:
     service-url: pulsar://localhost:6650
     tenant: recruitment-app
     namespace: dev
     enabled: true
   ```

3. **In `docker-compose.yml`, add Pulsar service:**
   ```yaml
   pulsar:
     image: apachepulsar/pulsar:3.3.0
     container_name: dar-pulsar
     ports:
       - "6650:6650"
       - "8082:8080"
     command: bin/pulsar standalone
     volumes:
       - pulsar_data:/pulsar/data
   ```
   Add the `pulsar_data` volume.

4. **Create `infra/config/PulsarConfig.kt`:**
   - Configuration class that creates a Pulsar client bean
   - Conditional on `pulsar.enabled=true`
   - Include error handling for connection failures (graceful degradation)

5. **Create a base `EventPublisherPort` interface** in the application layer ports (outbound):
   ```kotlin
   interface EventPublisherPort {
       fun publish(topic: String, event: Any)
   }
   ```

6. **Configure Avro serialization for Pulsar events:**
   - Add Avro dependency in `pom.xml`:
     ```xml
     <dependency>
         <groupId>org.apache.avro</groupId>
         <artifactId>avro</artifactId>
         <version>1.11.3</version>
     </dependency>
     ```
   - Configure Pulsar producer to use Avro schema (`Schema.AVRO(EventClass::class.java)`)
   - Generate Avro schemas from domain event classes
   - Per API spec, all Pulsar events MUST use Avro serialization (not JSON)

7. **Create `NoOpEventPublisher`** as a fallback adapter:
   - Logs events to stdout in JSON format when Pulsar is disabled
   - Useful for local development without Pulsar running

8. **In `application-test.yaml`:** Set `pulsar.enabled: false` so tests don't need Pulsar

**Acceptance Criteria:**
- Project compiles
- Application starts without Pulsar running (uses NoOp publisher, logs events)
- When Pulsar is running (`docker compose up pulsar`), the client connects successfully
- Test configuration disables Pulsar
