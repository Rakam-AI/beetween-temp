# T2.6 - Implement Request Creation & Editing Use Cases


**Depends on:** T2.2, T2.4, T2.5
**Blocks:** T2.7, T2.13, T2.15

**Context:**
Users need to create and edit recruitment requests. Creation requires selecting a published workflow. Editing is only possible while the request is in DRAFT status.

Reference:
- `API_Technical Specification V1.md` > POST /requests, PUT /requests/{id}, GET /requests, GET /requests/{id}

**Objective:**
Create use cases for Request CRUD operations.

**Instructions:**

1. **Create output ports in `application/request/port/output/`:**
   - **`RequestRepository.kt`:**
     ```kotlin
     interface RequestRepository {
         fun save(request: Request): Request
         fun findById(id: RequestId): Request?
         fun findByCompanyId(companyId: UUID, filters: RequestFilters, page: PageRequest): PageResult<Request>
         fun delete(id: RequestId)
     }

     data class RequestFilters(
         val status: RequestStatus? = null,
         val workflowId: WorkflowId? = null,
         val createdBy: UUID? = null,
         val sortBy: String? = null,
         val sortOrder: String? = null
     )
     ```
   - **`EventPublisherPort.kt`** (if not already created in T1.4):
     ```kotlin
     interface EventPublisherPort {
         fun publishRequestEvent(event: RequestEvent)
         fun publishWorkflowEvent(event: WorkflowEvent)
     }
     ```

2. **Create input ports in `application/request/port/input/`:**
   - `CreateRequestUseCase`
   - `UpdateRequestUseCase`
   - `GetRequestByIdUseCase`
   - `ListRequestsUseCase`
   - `DuplicateRequestUseCase`

3. **Create use case implementations:**

   a. **`CreateRequestService.kt`:**
   - Validate the selected workflowId exists and is PUBLISHED
   - Create Request via `Request.create()` with user info from JWT
   - Initialize additionalFieldValues from workflow's additionalFields defaults
   - Save and publish `RequestCreated` event
   - Return created request

   b. **`UpdateRequestService.kt`:**
   - Load request, validate ownership and DRAFT status
   - Call `request.update()` with new data
   - Implement optimistic locking check (compare version/updatedAt)
   - Save

   c. **`GetRequestByIdService.kt`:**
   - Load request, validate access (same company + either creator or in workflow)
   - Apply field visibility rules from the workflow's current step:
     - If user is at a step with hiddenFields → mask those fields (replace with "******")
     - readOnlyFields → return them but mark as read-only in response metadata

   d. **`ListRequestsService.kt`:**
   - Filter by company
   - Apply visibility rules: user sees only requests where they are creator OR a participant in the workflow
   - Support pagination, status filter, workflow filter, sorting
   - Support `pendingValidatorId` filter: returns only requests awaiting validation by the specified user

   e. **`DuplicateRequestService.kt`:**
   - Load the source request (validate it exists, status is REJECTED)
   - Only the creator can duplicate their own request
   - Call `request.duplicate()` to create a new DRAFT pre-filled with original data
   - Save the new request and publish `RequestCreated` event
   - Return the new request

4. **Write unit tests** for each use case

**Acceptance Criteria:**
- Request creation validates workflow is PUBLISHED before allowing creation
- Default additional field values are initialized from workflow
- Only the creator can edit a DRAFT request
- Optimistic locking prevents lost updates
- Field visibility rules applied (hidden fields masked, read-only fields marked)
- List query respects access control (only requests the user can see)
