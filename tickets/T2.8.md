# T2.8 - Implement Request Approval Use Case


**Depends on:** T2.4, T2.6
**Blocks:** T2.13

**Context:**
Approving a request is the most complex transition. It must handle both ONE and ALL validation modes, multi-step progression, and final approval.

Reference:
- `API_Technical Specification V1.md` > POST /requests/{id}/approval
- `Agent_Technical Specification V1.0.md` > "Etape 3a: Validation par le/les responsables"

**Objective:**
Create the ApproveRequestUseCase.

**Instructions:**

1. **Create `ApproveRequestUseCase` interface and `ApproveRequestService` implementation:**
   - Load request (validate exists, PENDING status)
   - Load associated workflow
   - Validate the current user is a validator at the current step
   - Validate required fields for the NEXT step are filled (if advancing)
   - Call `request.approve(validatorId, validatorType, comment, currentStep)`
   - Handle the result:
     - Step passed (advancing): check if next step's requiredFields are also filled
     - Final approval: mark as APPROVED
   - Save request (with optimistic locking for concurrent approvals)
   - Publish appropriate events:
     - `RequestValidationStepApproved` when a validator approves but step isn't done (ALL mode)
     - `RequestValidationStepPassed` when step advances
     - `RequestApproved` when final step is approved

2. **Handle concurrent approval:**
   - If two validators approve simultaneously in ALL mode, use optimistic locking (version field)
   - The first save wins, the second gets a `ConcurrentModification` error
   - The failed validator should retry (or the use case should retry automatically once)

3. **Write unit tests:**
   - Approve in ONE mode (single validator) → step advances
   - Approve in ALL mode (first validator) → partial, waiting
   - Approve in ALL mode (last validator) → step advances
   - Approve at final step → APPROVED
   - Approve by non-validator → error
   - Approve when not PENDING → error
   - Concurrent approval handling

**Acceptance Criteria:**
- ONE mode: single approval advances the step
- ALL mode: tracks partial approvals, advances only when all approved
- Final step approval transitions to APPROVED
- Concurrent modifications handled gracefully
- Appropriate events published for each scenario
