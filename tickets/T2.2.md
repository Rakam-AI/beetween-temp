# T2.2 - Implement Request Domain Model


**Depends on:** T1.7, T2.1
**Blocks:** T2.4, T2.6

**Context:**
The Request (recruitment approval request) is the second main aggregate. It represents a recruitment request that follows a workflow through validation steps. It has a complex lifecycle (DRAFT → PENDING → APPROVED/REJECTED → ARCHIVED) and contains rich business data.

Reference:
- `Agent_Technical Specification V1.0.md` > "Gestion des demandes de recrutement" (full section) and "Transitions d'une demande"
- `API_Technical Specification V1.md` > "Request et ses sous-objets" and "Modèles de données > Demande de recrutement"

**Objective:**
Create the Request aggregate root, all business data value objects, history entries, and status enums. No state machine logic yet (that's T2.4).

**Instructions:**
Create in `domain/request/model/`:

1. **`RequestId.kt`** - Value class wrapping UUID

2. **`RequestStatus.kt`** - Enum:
   ```kotlin
   enum class RequestStatus { DRAFT, PENDING, APPROVED, REJECTED, ARCHIVED, ABANDONED }
   ```

3. **`HistoryActionType.kt`** - Enum:
   ```kotlin
   enum class HistoryActionType { CREATE, UPDATE, SUBMIT, APPROVE, REJECT, COMMENT, ARCHIVE, ABANDON }
   ```

4. **`HistoryEntry.kt`** - Value object:
   ```kotlin
   data class HistoryEntry(
       val id: UUID = UUID.randomUUID(),
       val actionType: HistoryActionType,
       val timestamp: Instant,
       val userId: UUID,
       val userName: String,
       val stepIndex: Int? = null,
       val comment: String? = null,
       val details: HistoryDetails? = null
   )

   data class HistoryDetails(
       val changedFields: List<FieldChange>? = null,
       val comment: String? = null,
       val fromStatus: RequestStatus? = null,
       val toStatus: RequestStatus? = null
   )

   data class FieldChange(
       val fieldName: String,
       val oldValue: Any? = null,
       val newValue: Any? = null
   )
   ```

5. **Business data value objects** - Create in `domain/request/model/businessdata/`:

   - **`BusinessInfo.kt`**:
     ```kotlin
     data class BusinessInfo(
         val generalInfo: GeneralInfo? = null,
         val companyName: String? = null,
         val missionDescription: String? = null,
         val profileDescription: String? = null,
         val identity: CompanyIdentity? = null,
         val recruiterContact: Contact? = null,
         val jobLocation: JobLocation? = null,
         val contract: ContractInfo? = null,
         val remuneration: RemunerationInfo? = null,
         val position: PositionInfo? = null,
         val profileDetails: ProfileDetails? = null,
         val requiredLanguages: List<LanguageRequirement> = emptyList(),
         val applicationContact: ApplicationContact? = null
     )
     ```

   - **`GeneralInfo.kt`**:
     ```kotlin
     data class GeneralInfo(
         val contractType: String? = null,
         val location: Location? = null,
         val language: String? = null
     )
     data class Location(val country: String? = null, val city: String? = null)
     ```

   - **`CompanyIdentity.kt`**: with `displayNameInAd`, `legalName`, `siret`, `nafCode`, `address` (Address), `companyType`
   - **`Address.kt`**: with `street`, `postalCode`, `city`, `country`
   - **`Contact.kt`**: with `civility`, `lastName`, `firstName`, `email`, `phone`
   - **`JobLocation.kt`**: with `city`
   - **`ContractInfo.kt`**: with `type`, `form`, `remoteWork`, `duration`, `startDate`, `qualifications`
   - **`RemunerationInfo.kt`**: with `minSalary`, `maxSalary`, `currency`, `benefits`
   - **`PositionInfo.kt`**: with `domain`, `jobTitle`, `count`
   - **`ProfileDetails.kt`**: with `experienceLevel`, `hasDrivingLicense`, `handicapPolicy`
   - **`LanguageRequirement.kt`**: with `language`, `level`
   - **`ApplicationContact.kt`**: with contact sub-object, `email`, `link`, `phone`

   All fields should be nullable (since they're filled progressively and drafts can have missing data).

6. **`PendingValidators.kt`** - Tracks which validators have approved at the current step:
   ```kotlin
   data class PendingValidators(
       val stepIndex: Int,
       val approvedBy: List<ActorReference> = emptyList()
   )
   ```

7. **`Request.kt`** - Aggregate Root:
   ```kotlin
   class Request private constructor(
       val id: RequestId,
       var title: String,
       val workflowId: WorkflowId,
       val creatorId: UUID,
       val creatorName: String,
       val companyId: UUID,
       val createdAt: Instant,
       var updatedAt: Instant,
       var status: RequestStatus,
       var currentStepIndex: Int,
       var businessInfo: BusinessInfo,
       var additionalFieldValues: MutableMap<String, Any?>,
       var pendingValidators: PendingValidators?,
       val history: MutableList<HistoryEntry>,
       var version: Long = 0
   ) {
       companion object {
           fun create(
               title: String,
               workflowId: WorkflowId,
               creatorId: UUID,
               creatorName: String,
               companyId: UUID,
               businessInfo: BusinessInfo = BusinessInfo(),
               additionalFieldValues: Map<String, Any?> = emptyMap()
           ): Request { /* creates with DRAFT status, step 0, initial history entry */ }
       }
   }
   ```

8. **Create `domain/request/error/RequestError.kt`:**
   ```kotlin
   sealed class RequestError {
       data object RequestNotFound : RequestError()
       data object CannotModifySubmittedRequest : RequestError()
       data object CannotSubmitWithMissingFields : RequestError()
       data object WorkflowNotPublished : RequestError()
       data object UnauthorizedAction : RequestError()
       data object ConcurrentModification : RequestError()
       data object InvalidStatusTransition : RequestError()
       data class MissingRequiredFields(val fields: List<String>) : RequestError()
   }
   ```

9. **Create `domain/request/event/RequestEvent.kt`:**
   ```kotlin
   sealed class RequestEvent {
       abstract val requestId: RequestId
       abstract val timestamp: Instant

       data class RequestCreated(override val requestId: RequestId, val workflowId: WorkflowId, val companyId: UUID, val createdBy: UUID, val title: String, override val timestamp: Instant) : RequestEvent()
       data class RequestSubmitted(...) : RequestEvent()
       data class RequestStepApproved(...) : RequestEvent()
       data class RequestStepPassed(...) : RequestEvent()
       data class RequestApproved(...) : RequestEvent()
       data class RequestRejected(...) : RequestEvent()
       data class RequestAbandoned(...) : RequestEvent()
       data class RequestArchived(...) : RequestEvent()
   }
   ```
   Follow the event payload definitions from `API_Technical Specification V1.md` > "Structure des événements"

**Acceptance Criteria:**
- All classes compile with no dependencies on Spring or infrastructure
- `Request.create()` sets status=DRAFT, currentStepIndex=0, adds CREATE history entry
- All business data objects allow null fields (for draft saving)
- HistoryEntry captures all required information per the spec
- No state transition logic yet (that's T2.4)
