# T2.14 - Implement MongoDB Workflow Repository


**Depends on:** T1.3, T2.5
**Blocks:** T2.20

**Context:**
The Workflow repository persists workflows to MongoDB.

**Objective:**
Create the MongoDB adapter implementing the WorkflowRepository port.

**Instructions:**

1. **Create `adapter/output/persistence/workflow/entity/WorkflowDocument.kt`:**
   - MongoDB document class annotated with `@Document("workflows")`
   - All fields mapped from domain model
   - `@Id` on the id field
   - Include `@CreatedDate` and `@LastModifiedDate` for auditing
   - Include `version` field with `@Version` for optimistic locking

2. **Create `adapter/output/persistence/workflow/WorkflowDocumentMapper.kt`:**
   - `toDomain(document: WorkflowDocument): Workflow`
   - `toDocument(workflow: Workflow): WorkflowDocument`

3. **Create `adapter/output/persistence/workflow/SpringDataWorkflowRepository.kt`:**
   - Spring Data MongoDB repository interface extending `MongoRepository<WorkflowDocument, String>`
   - Custom query methods for findByCompanyId with pagination and status filter

4. **Create `adapter/output/persistence/workflow/MongoWorkflowRepositoryAdapter.kt`:**
   - Implements `WorkflowRepository` port
   - Uses Spring Data repository internally
   - Maps between domain and document objects
   - Implements `countActiveRequestsByWorkflowId` by querying the requests collection

5. **Create MongoDB indexes:**
   - Compound index on (companyId, publicationStatus) for filtered queries
   - Index on companyId for company isolation

**Acceptance Criteria:**
- All WorkflowRepository port methods implemented
- Domain-persistence mapping is bidirectional and lossless
- Pagination works correctly
- Optimistic locking via @Version
- Company-level data isolation in queries
