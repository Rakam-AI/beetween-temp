# T2.17 - Implement RBAC & Access Control


**Depends on:** T1.5, T2.12, T2.13
**Blocks:** T2.20

**Context:**
The application requires fine-grained access control based on JWT roles AND workflow-level permissions. This goes beyond simple role checks — it includes company isolation and step-level authorization.

Reference:
- `UI_Technical Specification V1 (FR) - AUTHENTICATION.md`
- `UI_TechnicalSpecification V1 (FR).md` > "Matrice de Permissions"
- `Agent_Technical Specification V1.0.md` > "Droits d'accès" sections

**Objective:**
Implement comprehensive access control throughout the application.

**Instructions:**

1. **Create `config/security/JwtClaimsExtractor.kt`:**
   - Extract from JWT: `sub` (userId), `email`, `realm_access.roles`, `companyId`, `preferred_username`
   - Create a `UserContext` data class:
     ```kotlin
     data class UserContext(
         val userId: UUID,
         val email: String,
         val username: String,
         val roles: Set<String>,
         val companyId: UUID
     )
     ```
   - Create a helper to build `UserContext` from Spring Security `Authentication`

2. **Create `application/shared/port/output/AuthorizationPort.kt`:**
   ```kotlin
   interface AuthorizationPort {
       fun getCurrentUser(): UserContext
       fun isAdmin(): Boolean
       fun hasRole(role: String): Boolean
   }
   ```

3. **Implement role-based access:**
   - Workflow CRUD: ADMIN only (for write operations)
   - Request creation: RECRUITER, MANAGER, HR_MANAGER
   - Request approval/rejection: Validators defined in current step of the workflow
   - Request commenting: Commentators defined in current step + validators + creator
   - Request archival: Creator (for DRAFT) or ADMIN (for APPROVED/REJECTED)

4. **Implement company-level data isolation:**
   - All repository queries MUST filter by companyId
   - A user from company A cannot see or modify data from company B
   - This must be enforced at the use case level

5. **Implement workflow-step-level authorization:**
   - When checking if a user can approve/reject/comment, check:
     1. User is in the current step's validators/commentators list
     2. Match by either userId (if actor type is USER) or by role (if actor type is ROLE)

6. **Update `SecurityWebConfig.kt`:**
   - Configure JWT authorities extraction
   - Set up method security (`@PreAuthorize` support)
   - Configure CORS for frontend origins (localhost:3000, 3001)

**Acceptance Criteria:**
- JWT claims correctly extracted into UserContext
- Company isolation enforced on all queries
- Role-based access on endpoints (admin for workflow writes)
- Step-level authorization for approval/rejection/comment
- CORS configured for frontend
- Creator always has read access to their own requests
