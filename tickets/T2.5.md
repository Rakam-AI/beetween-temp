# T2.5 - Implement Workflow CRUD Use Cases


**Depends on:** T2.1, T2.3
**Blocks:** T2.6, T2.12, T2.14

**Context:**
The application layer orchestrates domain operations by implementing use case interfaces (driving ports) and depending on repository/publisher interfaces (driven ports).

Reference: `API_Technical Specification V1.md` > "Endpoints principaux > Gestion des workflows"

**Objective:**
Create all Workflow use cases with their input/output ports.

**Instructions:**

1. **Create output ports in `application/workflow/port/output/`:**
   - **`WorkflowRepository.kt`:**
     ```kotlin
     interface WorkflowRepository {
         fun save(workflow: Workflow): Workflow
         fun findById(id: WorkflowId): Workflow?
         fun findByCompanyId(companyId: UUID, page: PageRequest, publicationStatus: PublicationStatus?): PageResult<Workflow>
         fun delete(id: WorkflowId)
         fun existsById(id: WorkflowId): Boolean
         fun countActiveRequestsByWorkflowId(workflowId: WorkflowId): Long
     }
     ```

2. **Create input ports (use cases) in `application/workflow/port/input/`:**
   - `CreateWorkflowUseCase`
   - `UpdateWorkflowUseCase`
   - `GetWorkflowByIdUseCase`
   - `ListWorkflowsUseCase`
   - `DeleteWorkflowUseCase`
   - `ChangeWorkflowStatusUseCase` (publish/unpublish)

3. **Create use case implementations in `application/workflow/usecase/`:**

   a. **`CreateWorkflowService.kt`:**
   - Takes: name, description, steps, additionalFields, globalRequiredFields + current user info (userId, companyId)
   - Validates admin role
   - Calls `Workflow.create()` factory
   - Saves via repository
   - Publishes `WorkflowCreated` event
   - Returns created workflow id

   b. **`UpdateWorkflowService.kt`:**
   - Loads workflow from repository
   - Validates: user is admin, same company, workflow is in DRAFT
   - Calls `workflow.update()`
   - Saves via repository
   - Publishes `WorkflowUpdated` event

   c. **`GetWorkflowByIdService.kt`:**
   - Loads workflow, validates company access
   - Returns workflow or error

   d. **`ListWorkflowsService.kt`:**
   - Lists workflows for user's company with pagination and optional status filter

   e. **`DeleteWorkflowService.kt`:**
   - Validates: admin, DRAFT status, no active requests using it
   - Deletes via repository

   f. **`ChangeWorkflowStatusService.kt`:**
   - Handles both publish and unpublish
   - Validates admin role
   - Delegates to `workflow.publish()` or `workflow.unpublish()`
   - Saves and publishes event

4. **Create use case commands/queries** as data classes for each operation

5. **Write unit tests** for each use case using MockK for ports

**Acceptance Criteria:**
- All use cases implement their input port interface
- All use cases use constructor-injected output ports
- Company-level data isolation enforced in all queries
- Admin role checked for all write operations
- Unit tests cover success and error paths
