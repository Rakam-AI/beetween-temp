# T2.12 - Implement Workflow REST Controller


**Depends on:** T2.5, T1.6, T1.8
**Blocks:** T2.17, T2.20

**Context:**
The Workflow controller exposes REST endpoints for CRUD operations and status changes.

Reference: `API_Technical Specification V1.md` > "Endpoints principaux > Gestion des workflows"

**Objective:**
Create the REST controller with all workflow endpoints, proper DTOs, and OpenAPI documentation.

**Instructions:**

1. **Create DTOs in `adapter/input/web/workflow/dto/`:**

   - **`WorkflowInputDto.kt`**: Maps to WorkflowInput from spec
     - name (String, required)
     - description (String, optional)
     - steps (List<WorkflowStepDto>, required, non-empty)
     - additionalFields (List<AdditionalFieldDto>, optional)
     - globalRequiredFields (List<String>, optional)

   - **`WorkflowOutputDto.kt`**: Maps to WorkflowOutput from spec
     - id, name, description, status, createdAt, updatedAt, activeRequestsCount
     - steps, additionalFields, globalRequiredFields

   - **`WorkflowStepDto.kt`**: name, icon, validators, commentators, validationMode, requiredFields, hiddenFields, readOnlyFields

   - **`WorkflowStepActorDto.kt`**: type (ROLE/USER), id

   - **`AdditionalFieldDto.kt`**: name, label, type, options, defaultValue

   - **`WorkflowStatusChangeDto.kt`**: status (PUBLISHED/UNPUBLISHED)

2. **Create mapper functions** between DTOs and domain models (extension functions or a mapper object)

3. **Create `adapter/input/web/workflow/WorkflowController.kt`:**
   ```kotlin
   @RestController
   @RequestMapping("/api/v1/workflows")
   class WorkflowController(
       private val createWorkflow: CreateWorkflowUseCase,
       private val updateWorkflow: UpdateWorkflowUseCase,
       private val getWorkflow: GetWorkflowByIdUseCase,
       private val listWorkflows: ListWorkflowsUseCase,
       private val deleteWorkflow: DeleteWorkflowUseCase,
       private val changeStatus: ChangeWorkflowStatusUseCase
   ) {
       @PostMapping
       fun create(@Valid @RequestBody input: WorkflowInputDto, auth: Authentication): ResponseEntity<ApiResponse<String>>

       @PutMapping("/{id}")
       fun update(@PathVariable id: String, @Valid @RequestBody input: WorkflowInputDto, auth: Authentication): ResponseEntity<ApiResponse<Void>>

       @GetMapping
       fun list(@RequestParam page: Int?, @RequestParam size: Int?, @RequestParam publicationStatus: String?, auth: Authentication): ResponseEntity<ApiResponse<List<WorkflowOutputDto>>>

       @GetMapping("/{id}")
       fun getById(@PathVariable id: String, auth: Authentication): ResponseEntity<ApiResponse<WorkflowOutputDto>>

       @DeleteMapping("/{id}")
       fun delete(@PathVariable id: String, auth: Authentication): ResponseEntity<Void>

       @PutMapping("/{id}/status")
       fun changeStatus(@PathVariable id: String, @RequestBody body: WorkflowStatusChangeDto, auth: Authentication): ResponseEntity<ApiResponse<Void>>
   }
   ```

4. **Extract user info from Authentication** (userId, companyId, roles from JWT claims)

5. **Add OpenAPI annotations** (`@Operation`, `@ApiResponse`, `@Parameter`) on all endpoints

6. **Use `@PreAuthorize("hasRole('ADMIN')")` or equivalent** for admin-only endpoints (POST, PUT, DELETE, status change)

**Acceptance Criteria:**
- All 6 endpoints match the API specification exactly
- Proper HTTP status codes (201 for create, 200 for updates/reads, 204 for delete)
- Response wrapper format used consistently
- Pagination support on list endpoint
- OpenAPI documentation generated correctly
- Bean validation on input DTOs (@NotBlank, @NotEmpty, etc.)
- Admin role enforced on write endpoints
