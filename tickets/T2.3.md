# T2.3 - Implement Workflow Domain Business Rules


**Depends on:** T2.1
**Blocks:** T2.5

**Context:**
The Workflow aggregate needs enforcement of all business rules defined in the functional specification.

Reference: `Agent_Technical Specification V1.0.md` > "Gestion des workflows" > "Règles de gestion"

**Objective:**
Implement and test all business rules within the Workflow aggregate.

**Instructions:**
1. **In `Workflow.kt`, implement the following rules:**

   a. **Creation rules:**
   - Name must not be blank
   - Must have at least one step
   - Each step must have at least one validator
   - Initial status is DRAFT

   b. **Update rules:**
   - Can only update when status is DRAFT
   - Return `Err(CannotModifyPublishedWorkflow)` if PUBLISHED or UNPUBLISHED
   - On update, set `updatedAt` to current time

   c. **Publication rules:**
   - `publish()`: Only from DRAFT → PUBLISHED
   - `unpublish()`: Only from PUBLISHED → UNPUBLISHED
   - Cannot go from UNPUBLISHED back to DRAFT or PUBLISHED

   d. **Deletion rules:**
   - `canBeDeleted()`: Returns true only if status is DRAFT (not PUBLISHED, not UNPUBLISHED)
   - Note: checking for active requests is done at the use case level (needs repository access)

   e. **Step validation:**
   - Each step must have a unique name within the workflow (warning: spec doesn't explicitly say this, so just validate non-blank)
   - Validation mode must be set
   - requiredFields, hiddenFields, readOnlyFields should not overlap within a step

2. **Create `domain/workflow/model/WorkflowTest.kt`** in test sources:
   - Test creation with valid data
   - Test creation with blank name (should fail)
   - Test creation with no steps (should fail)
   - Test creation with step having no validators (should fail)
   - Test publish from DRAFT (should succeed)
   - Test publish from PUBLISHED (should fail)
   - Test publish from UNPUBLISHED (should fail)
   - Test unpublish from PUBLISHED (should succeed)
   - Test unpublish from DRAFT (should fail)
   - Test update when DRAFT (should succeed)
   - Test update when PUBLISHED (should fail)
   - Test canBeDeleted in DRAFT (true)
   - Test canBeDeleted in PUBLISHED (false)

**Acceptance Criteria:**
- All domain rules implemented in the aggregate
- Unit tests pass with > 90% coverage of the Workflow domain
- No infrastructure dependencies
- Uses `Result<T, WorkflowError>` from kotlin-result
